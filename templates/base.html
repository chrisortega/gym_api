<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">{% block title %}Gym{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .gym-logo {
      width: 35px;
      height: 35px;
      object-fit: cover;
      border-radius: 50%;
      margin-right: 10px;
    }
  </style>
</head>

<body class="bg-light">

  <!-- ‚úÖ Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container-fluid">
      <a id="gymNameBrand" class="navbar-brand fw-bold d-flex align-items-center" href="/">
        <img id="gymLogo" src="/static/default-gym.png" alt="Logo" class="gym-logo">
        <span id="gymNameText">üèãÔ∏è Cargando...</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
              aria-controls="navbarNav" aria-expanded="false" aria-label="Alternar navegaci√≥n">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav align-items-center">
          <li class="nav-item">
            <a id="authLink" class="nav-link {% if request.path == '/' %}active{% endif %}" href="/">
              Iniciar sesi√≥n
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- ‚úÖ Main Page Content -->
  <div class="container mt-5 pt-4">
    {% block content %}{% endblock %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const token = localStorage.getItem("token");
      const userData = JSON.parse(localStorage.getItem("user") || "{}");
      const gymNameText = document.getElementById("gymNameText");
      const gymLogo = document.getElementById("gymLogo");
      const pageTitle = document.getElementById("pageTitle");

      let gymName = "Mi Gimnasio";
      let gymImage = "/static/default-gym.png";

      if (token && userData.gym_id) {
        try {
          const res = await fetch(`/api/gym/${userData.gym_id}`, {
            headers: { "Authorization": `Bearer ${token}` }
          });

          if (res.ok) {
            const gym = await res.json();
            gymName = gym.name || gymName;

            // ‚úÖ If image blob exists, convert to base64
            if (gym.image) {
              gymImage = `data:image/jpeg;base64,${gym.image}`;
            }
          }
        } catch (err) {
          console.warn("No se pudo cargar el nombre o imagen del gimnasio:", err);
        }
      }

      // ‚úÖ Update UI
      gymNameText.textContent = ` ${gymName}`;
      gymLogo.src = gymImage;
      pageTitle.textContent = gymName;

      // ‚úÖ Handle login/logout
      const authLink = document.getElementById("authLink");
      if (token) {
        authLink.textContent = "Cerrar sesi√≥n";
        authLink.href = "#";
        authLink.classList.add("text-danger", "fw-semibold");
        authLink.addEventListener("click", (e) => {
          e.preventDefault();
          logout();
        });
      }
    });

    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      window.location.href = "/";
    }
  </script>
</body>
</html>
