{% extends "base.html" %}

{% block title %}Detalles del Usuario - {{ gym_name or "Gimnasio" }}{% endblock %}

{% block content %}
<style>
  body { background-color: #f8f9fa; }

  .expired { background-color: #f8d7da; }
  .active { background-color: #d1e7dd; }
  .near-expiry { background-color: #fff3cd; }

  #preview {
    display: none;
    border-radius: 50%;
    width: 180px;
    height: 180px;
    object-fit: cover;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }

  h3, h4 {
    color: #343a40;
  }
</style>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3>üë§ Detalles del Usuario</h3>
    <div>
      <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#editUserModal">‚úèÔ∏è Editar</button>
      <a href="/entries" class="btn btn-outline-secondary">‚¨Ö Volver</a>
    </div>
  </div>

  <!-- Informaci√≥n del Usuario -->
  <div id="userInfo" class="mb-4 text-center">
    <img id="preview" class="mt-3 mx-auto d-block">
    <h4 id="userName" class="mt-3 fw-bold">Cargando...</h4>
    <p><strong>Expiraci√≥n:</strong> <span id="userExp"></span></p>
  </div>

  <!-- Historial de Entradas -->
  <h5 class="mb-3">üóìÔ∏è Historial de Entradas</h5>
  <table class="table table-hover align-middle shadow-sm rounded">
    <thead class="table-dark">
      <tr>
        <th scope="col">Fecha</th>
        <th scope="col">N√∫mero de Entradas</th>
      </tr>
    </thead>
    <tbody id="entriesContainer">
      <tr><td colspan="2" class="text-center text-muted py-3">Cargando...</td></tr>
    </tbody>
  </table>
  <a href="/biometrics" id="bioLink" class="btn btn-outline-primary mt-3">Biometrics</a>
    


</div>

<!-- üß© Modal de Edici√≥n -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar Usuario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editUserForm">
          <div class="mb-3">
            <label for="editName" class="form-label">Nombre</label>
            <input type="text" id="editName" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="editExp" class="form-label">Fecha de Expiraci√≥n</label>
            <input type="date" id="editExp" class="form-control">
          </div>
          <div class="mb-3">
            <label for="editImage" class="form-label">Foto</label>
            <input type="file" id="editImage" class="form-control" accept="image/*">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" onclick="guardarCambios()">üíæ Guardar</button>
      </div>
    </div>
  </div>

  
</div>

<script>
  const token = localStorage.getItem("token");
  const params = new URLSearchParams(window.location.search);
  const userId = params.get("user_id");


  if (!token || !userId) {
    alert("Acceso inv√°lido ‚Äî por favor regresa al panel principal.");
    window.location.href = "/entries";

  }
  document.getElementById("bioLink").href = `/biometrics?user_id=${userId}`;

  window.addEventListener("DOMContentLoaded", cargarDetalles);

  async function cargarDetalles() {
    try {
      const userRes = await fetch(`/api/users/${userId}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const user = await userRes.json();

      const expDate = user.exp ? new Date(user.exp) : null;


      if (expDate) {
          const today = new Date();
          today.setHours(0,0,0,0);

          if (expDate < today) {
              document.getElementById("userExp").classList.add("text-danger", "fw-bold");
              document.getElementById("userExp").textContent += " (Expirado)";

              // Optional: Banner de alerta si quieres
              const userInfo = document.getElementById("userInfo");
              userInfo.insertAdjacentHTML("beforeend", `
                <div class="alert alert-danger mt-3">
                  ‚ö†Ô∏è Este usuario est√° expirado.
                </div>
              `);
          }
      }
      
      let formattedExp = expDate ? expDate.toLocaleDateString("es-MX") : "‚Äî";

      document.getElementById("userName").textContent = user.name || "Desconocido";
      document.getElementById("userExp").textContent = formattedExp;
      document.getElementById("editName").value = user.name || "";
      document.getElementById("editExp").value = expDate ? expDate.toISOString().slice(0, 10) : "";




      const img = document.getElementById("preview");
      if (user.image) {
        img.src = `data:image/jpeg;base64,${user.image}`;
      } else {
        img.src = "/static/default-user.png";
      }
      img.style.display = "block";

      // üßæ Cargar historial
      const entriesRes = await fetch(`/api/entries/user/${userId}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      mostrarEntradas(await entriesRes.json());
    } catch (err) {
      console.error(err);
      alert("Error al cargar los datos del usuario.");
    }
  }

  function mostrarEntradas(entries) {
    const container = document.getElementById("entriesContainer");
    container.innerHTML = "";

    if (!Array.isArray(entries) || entries.length === 0) {
      container.innerHTML = `<tr><td colspan="2" class="text-center text-muted py-3">No hay registros de entrada para este usuario.</td></tr>`;
      return;
    }

    const dayMap = new Map();
    for (const entry of entries) {
      const date = new Date(entry.day).toLocaleDateString("es-MX");
      dayMap.set(date, (dayMap.get(date) || 0) + 1);
    }

    const sortedDates = Array.from(dayMap.keys()).sort((a, b) => new Date(b) - new Date(a));

    sortedDates.forEach(date => {
      const count = dayMap.get(date);
      container.innerHTML += `<tr><td>${date}</td><td>${count}</td></tr>`;
    });
  }

  async function guardarCambios() {
    const name = document.getElementById("editName").value;
    const exp = document.getElementById("editExp").value;
    const imageFile = document.getElementById("editImage").files[0];

    let base64Image = null;
    if (imageFile) {
      base64Image = await new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(",")[1]);
        reader.readAsDataURL(imageFile);
      });
    }

    const payload = { name, exp, image: base64Image };

    const res = await fetch(`/api/users/${userId}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      alert("‚úÖ Usuario actualizado correctamente.");
      document.getElementById("editUserForm").reset();
      const modal = bootstrap.Modal.getInstance(document.getElementById("editUserModal"));
      modal.hide();
      cargarDetalles(); // Recargar informaci√≥n
    } else {
      alert("‚ùå No se pudo actualizar el usuario.");
    }
  }

  
  
</script>
{% endblock %}
