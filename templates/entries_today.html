{% extends "base.html" %}

{% block title %}Entradas de Hoy - GymAdmin{% endblock %}

{% block content %}
<style>
  body {
    background-color: #f8f9fa;
  }

  .user-thumb {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid #ccc;
  }

  .user-cell {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }

  table {
    background-color: white;
  }

  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    table {
      font-size: 0.9rem;
    }
    th, td {
      white-space: nowrap;
    }
  }
</style>

<div class="p-3">
  <div class="page-header">
    <h3 class="m-0">üèãÔ∏è Entradas de Hoy</h3>
    <a href="/dashboard" class="btn btn-outline-secondary btn-sm">‚¨Ö Volver</a>
  </div>

<!-- Nueva entrada -->
<style>
  #userIdInput {
    font-size: 2rem !important;
    padding: 20px !important;
    height: 80px;
    text-align: center;
  }
</style>

<div class="mb-4">
  <input id="userIdInput" type="number" class="form-control form-control-lg"
         placeholder="Ingresa el ID del usuario y presiona ENTER">
  <div id="alertContainer" class="mt-2"></div>
</div>


  <!-- Tabla -->
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle text-center">
      <thead class="table-dark">
        <tr>
          <th>ID Usuario</th>
          <th>Usuario</th>
          <th>Expiraci√≥n</th>
          <th>Entradas Hoy</th>
        </tr>
      </thead>
      <tbody id="entriesContainer">
        <tr><td colspan="4" class="text-center text-muted">Cargando...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  const token = localStorage.getItem("token");
  const userData = JSON.parse(localStorage.getItem("user") || "{}");
  const gymId = userData.gym_id;
  const container = document.getElementById("entriesContainer");

  if (!token || !gymId) {
    showAlert("Faltan datos de sesi√≥n. Por favor inicia sesi√≥n nuevamente.", "warning");
    setTimeout(() => window.location.href = "/", 1500);
  }

  
  window.addEventListener("DOMContentLoaded", loadEntries);



  document.getElementById("userIdInput").addEventListener("keyup", function (e) {
      if (e.key === "Enter") {
          const userId = this.value;
          addEntry(); // replace with your real function
      }
  });

  async function loadEntries() {
    container.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Cargando entradas...</td></tr>`;

    try {
      const response = await fetch(`/api/entries/today/${gymId}?limit=200`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const data = await response.json();
      container.innerHTML = "";

      if (!Array.isArray(data) || data.length === 0) {
        container.innerHTML = `<tr><td colspan="4" class="text-center text-muted">No hay entradas registradas hoy.</td></tr>`;
        return;
      }

      // Contar entradas por usuario
      const entryCounts = {};
      data.forEach(entry => {
        entryCounts[entry.user_id] = (entryCounts[entry.user_id] || 0) + 1;
      });

      // Evitar duplicados
      const seenUsers = new Set();
      const uniqueEntries = [];
      for (const user of data) {
        if (!seenUsers.has(user.user_id)) {
          seenUsers.add(user.user_id);
          uniqueEntries.push(user);
        }
      }

      // Renderizar filas
      uniqueEntries.forEach(user => {
        const expDate = new Date(user.exp);
        const formattedDate = expDate.toLocaleDateString("es-MX");
        const entryCount = entryCounts[user.user_id] || 1;
        const userImg = user.image
          ? `data:image/jpeg;base64,${user.image}`
          : "https://via.placeholder.com/40?text=?";

        container.innerHTML += `
          <tr>
            <td>${user.user_id}</td>
            <td>
              <div class="user-cell">
                <img src="${userImg}" class="user-thumb" alt="Imagen de usuario">
                <a href="/user?user_id=${user.user_id}" class="fw-bold text-decoration-none text-dark">${user.name}</a>
              </div>
            </td>
            <td>${formattedDate}</td>
            <td><span class="badge bg-primary">${entryCount}</span></td>
          </tr>
        `;
      });
    } catch (err) {
      console.error(err);
      container.innerHTML = `<tr><td colspan="4" class="text-danger text-center">Error al cargar las entradas.</td></tr>`;
    }
  }

  async function addEntry() {
  const userId = document.getElementById("userIdInput").value.trim();
  if (!userId) {
    showAlert("Por favor ingresa el ID del usuario.", "warning");
    return;
  }

  try {
    const response = await fetch(`/api/entries`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ user_id: userId, gym_id: gymId })
    });

    if (response.ok) {
      showAlert("‚úÖ Entrada registrada exitosamente.", "success");
      document.getElementById("userIdInput").value = "";
      loadEntries();
    } else {
      const err = await response.json();
      showAlert(`‚ùå No se pudo registrar la entrada: ${err.error || "Error desconocido."}`, "danger");
    }
  } catch (error) {
    console.error(error);
    showAlert("‚ö†Ô∏è Error del servidor. Intenta nuevamente.", "danger");
  }
}


  function showAlert(message, type) {
    document.getElementById("alertContainer").innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show p-2" role="alert">
        ${message}
        <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert"></button>
      </div>
    `;
  }
</script>
{% endblock %}
