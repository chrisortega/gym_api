<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Today's Gym Entries</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .expired { background-color: #f8d7da; }
    .active { background-color: #d1e7dd; }
    .near-expiry { background-color: #fff3cd; }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>üèãÔ∏è Today's Gym Entries</h2>
      <a href="/dashboard" class="btn btn-outline-secondary">‚¨Ö Back</a>
    </div>

    <!-- Add new entry -->
    <div class="input-group mb-4">
      <input id="userIdInput" type="number" class="form-control" placeholder="Enter User ID to add entry">
      <button id="addEntryBtn" class="btn btn-success">Add Entry</button>
    </div>

    <!-- Entries table -->
    <table class="table table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th scope="col">User ID</th>
          <th scope="col">Name</th>
          <th scope="col">Expiration</th>
          <th scope="col">Status</th>
          <th scope="col">Entries Today</th>
        </tr>
      </thead>
      <tbody id="entriesContainer">
        <tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    const token = localStorage.getItem("token");
    const userData = JSON.parse(localStorage.getItem("user") || "{}");
    const gymId = userData.gym_id;
    const container = document.getElementById("entriesContainer");

    if (!token || !gymId) {
      alert("Missing login or gym information. Please sign in again.");
      window.location.href = "/";
    }

    document.getElementById("addEntryBtn").addEventListener("click", addEntry);

    // üß† Load entries on page load
    window.addEventListener("DOMContentLoaded", loadEntries);

    async function loadEntries() {
      container.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Loading entries...</td></tr>`;

      try {
        const response = await fetch(`/api/entries/today/${gymId}?limit=200`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await response.json();
        container.innerHTML = "";

        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No entries found for today.</td></tr>`;
          return;
        }

        // üß© Count entries per user
        const entryCounts = {};
        data.forEach(entry => {
          entryCounts[entry.user_id] = (entryCounts[entry.user_id] || 0) + 1;
        });

        // üß© Deduplicate users
        const uniqueEntries = [];
        const seenUsers = new Set();

        for (const user of data) {
          if (!seenUsers.has(user.user_id)) {
            seenUsers.add(user.user_id);
            uniqueEntries.push(user);
          }
        }

        // üß± Render unique users with entry counts
        uniqueEntries.forEach(user => {
          const expDate = new Date(user.exp);
          const today = new Date();
          const formattedDate = expDate.toLocaleDateString("en-CA");

          let status = "Active";
          let rowClass = "active";
          if (expDate < today) {
            status = "Expired";
            rowClass = "expired";
          } else if ((expDate - today) / (1000 * 3600 * 24) < 7) {
            status = "Near Expiry";
            rowClass = "near-expiry";
          }

          const entryCount = entryCounts[user.user_id] || 1;

          container.innerHTML += `
            <tr class="${rowClass}">
              <td>${user.user_id}</td>
              <td>
                <a href="/user?user_id=${user.user_id}" class="fw-bold text-decoration-none">${user.name}</a>
              </td>
              <td>${formattedDate}</td>
              <td>${status}</td>
              <td><span class="badge bg-primary">${entryCount}</span></td>
            </tr>
          `;
        });
      } catch (err) {
        console.error(err);
        container.innerHTML = `<tr><td colspan="5" class="text-danger text-center">Error loading entries.</td></tr>`;
      }
    }

    // ‚ûï Add a new entry
    async function addEntry() {
      const userId = document.getElementById("userIdInput").value.trim();
      if (!userId) return alert("Please enter a user ID.");

      try {
        const response = await fetch(`/api/entries`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ user_id: userId, gym_id: gymId })
        });

        if (response.ok) {
          alert("Entry added successfully!");
          document.getElementById("userIdInput").value = "";
          loadEntries();
        } else {
          const err = await response.text();
          alert(`Failed to add entry: ${err}`);
        }
      } catch (error) {
        console.error(error);
        alert("Error adding entry.");
      }
    }
  </script>
</body>
</html>
