{% extends "base.html" %}
{% block title %}Usuarios - {{ gym_name or "Gimnasio" }}{% endblock %}

{% block content %}
<style>
  body { background-color: #f8f9fa; }

  .table-hover tbody tr:hover {
    background-color: #eef6ff;
    cursor: pointer;
  }

  .expired-row {
    background-color: #f8d7da !important;
  }

  .near-expiry-row {
    background-color: #fff3cd !important;
  }

  .active-row {
    background-color: #d1e7dd !important;
  }

  .user-img {
    border-radius: 50%;
    width: 48px;
    height: 48px;
    object-fit: cover;
  }

  .action-btns button {
    margin: 0 3px;
  }

  .title-icon {
    font-size: 1.6rem;
    margin-right: 8px;
  }

  .badge-status {
    font-size: 0.8rem;
    padding: 4px 8px;
    border-radius: 6px;
  }

  .badge-expired {
    background-color: #dc3545;
    color: white;
  }

  .badge-warning {
    background-color: #ffc107;
    color: black;
  }

  .badge-success {
    background-color: #198754;
    color: white;
  }
</style>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold text-secondary">
      <i class="bi bi-people-fill title-icon text-primary"></i> Administrar Usuarios
    </h3>
    <div>
      <a href="/dashboard" class="btn btn-outline-secondary me-2">⬅ Volver</a>
      <a href="/add-user" class="btn btn-primary">➕ Agregar Usuario</a>
    </div>
  </div>

  <!-- Tabla de Usuarios -->
  <div class="table-responsive shadow-sm rounded">
    <table class="table table-striped table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th scope="col">#</th>
          <th scope="col" class="text-center">Foto</th>
          <th scope="col">Nombre</th>
          <th scope="col">Expira</th>
          
        </tr>
      </thead>
      <tbody id="usersTableBody"></tbody>
    </table>
  </div>
</div>

<script>
  const token = localStorage.getItem('token');
  const userData = JSON.parse(localStorage.getItem('user') || '{}');
  const gymId = userData.gym_id;
  const tableBody = document.getElementById("usersTableBody");

  if (!token || !gymId) window.location.href = '/';

  async function fetchUsers() {
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3">Cargando usuarios...</td></tr>`;

    try {
      const res = await fetch(`/api/users/gym/${gymId}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const users = await res.json();
      tableBody.innerHTML = "";

      if (!users.length) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3">Aún no hay usuarios registrados.</td></tr>`;
        return;
      }

      const today = new Date();

      users.forEach((user, index) => {
        const expDate = new Date(user.exp);
        const diffDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));

        let rowClass = "active-row";
        let badgeClass = "badge-success";
        let badgeText = "Activo";

        if (diffDays <= 0) {
          rowClass = "expired-row";
          badgeClass = "badge-expired";
          badgeText = "Expirado";
        } else if (diffDays <= 7) {
          rowClass = "near-expiry-row";
          badgeClass = "badge-warning";
          badgeText = "Por Expirar";
        }

        const imgSrc = user.image
          ? `data:image/jpeg;base64,${user.image}`
          : "/static/default-user.png";

        const tr = document.createElement('tr');
        tr.className = rowClass;
        tr.innerHTML = `
          <td>${user.id}</td>
          <td class="text-center"><img src="${imgSrc}" class="user-img" ></td>
          <td>${user.name}</td>
          <td>
            ${user.exp ? new Date(user.exp).toISOString().split("T")[0] : "N/A"}
            <span class="badge-status ${badgeClass} ms-2">${badgeText}</span>
          </td>

        `;

        tr.addEventListener('click', (e) => {
          if (!e.target.closest('button')) {
            window.location.href = `/user?user_id=${user.id}`;
          }
        });

        tableBody.appendChild(tr);
      });
    } catch (err) {
      console.error("Error al cargar usuarios:", err);
      tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-3">No se pudieron cargar los usuarios.</td></tr>`;
    }
  }



  // Cargar usuarios al inicio
  fetchUsers();
</script>
{% endblock %}
